- name: "Import the archzfs-repo-key to the new machine pacman keyring"
  command: arch-chroot {{ arch_install_def_arch_chroot_dir|quote }}
                       pacman-key --recv-keys {{ arch_install_def_archzfs_repo_key|quote }}

- name: "Sign the imported archzfs-repo-key"
  command: arch-chroot {{ arch_install_def_arch_chroot_dir|quote }}
                       pacman-key --lsign-key {{ arch_install_def_archzfs_repo_key|quote }}

- name: "Add 'archzfs-kernels' repo as first-priority repo in pacman.conf"
  blockinfile:
    path: "{{ arch_install_def_arch_chroot_dir }}/etc/pacman.conf"
    insertbefore: '^\[core\]$'
    block: |
      [archzfs-kernels]
      Server = http://end.re/$repo
    marker: "# {mark} ANSIBLE MANAGED BLOCK: archzfs-kernels"
    state: present

- name: "Add 'archzfs' repo as last-priority repo in pacman.conf"
  blockinfile:
    path: "{{ arch_install_def_arch_chroot_dir }}/etc/pacman.conf"
    insertafter: EOF
    block: |
      [archzfs]
      Server = http://archzfs.com/$repo/x86_64
    marker: "# {mark} ANSIBLE MANAGED BLOCK: archzfs"
    state: present

- name: "Refresh the pacman database"
  command: arch-chroot {{ arch_install_def_arch_chroot_dir|quote }}
                       pacman --noconfirm -Syy

- name: "Install 'zfs-linux' and 'zfs-linux-lts' packages to chroot"
  command: arch-chroot {{ arch_install_def_arch_chroot_dir|quote }}
                       pacman --noconfirm -S archzfs-linux archzfs-linux-lts

