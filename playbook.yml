- hosts: localhost
  become: true
  connection: local
  pre_tasks:
    - name: "Import variables from optional, user-specified file"
      include_vars:
        file: "{{ user_vars_file }}"
      when: user_vars_file is defined
      ignore_errors: true
    - name: "Abort if user did not specify user_var_motherboard_type"
      fail:
        msg: "user_var_motherboard_type variable must be specified (see group_vars/all file)"
      when: user_var_motherboard_type != "bios" and user_var_motherboard_type != "uefi"
    - name: "Abort if user did not specify user_var_device_1"
      fail:
        msg: "user_var_device_1 variable must be set to 'sdx' (see group_vars/all file)"
      when: user_var_device_1 is not regex("^sd.$")
    - name: "Compose '_mirror' string-appends if installing to mirrored disks"
      set_fact:
        mirror0_append: "{{ '_mirror0' if user_var_device_2 is regex('^sd.$') else '' }}"
        mirror1_append: "{{ '_mirror1' if user_var_device_2 is regex('^sd.$') else '' }}"
        device_2_boot_base: "{{ const_var_boot_partlabel_base if user_var_device_2 is regex('^sd.$') else '' }}"
        device_2_zfs_base: "{{ const_var_zfs_partlabel_base if user_var_device_2 is regex('^sd.$') else '' }}"
    - name: "Compose partition-label strings for the installation disk(s)"
      set_fact:
        play_fact_device_1_boot_partlabel: "{{ const_var_boot_partlabel_base }}{{ mirror0_append }}"
        play_fact_device_1_zfs_partlabel: "{{ const_var_zfs_partlabel_base }}{{ mirror0_append }}"
        play_fact_device_2_boot_partlabel: "{{ device_2_boot_base }}{{ mirror1_append }}"
        play_fact_device_2_zfs_partlabel: "{{ device_2_zfs_base }}{{ mirror1_append }}"
  tasks:
    - include_role:
        name: disk-format
      vars:
        disk_format_def_motherboard_type: "{{ user_var_motherboard_type }}"
        disk_format_def_device_1: "{{ user_var_device_1 }}"
        disk_format_def_device_2: "{{ user_var_device_2 }}"
        disk_format_def_device_1_boot_partlabel: "{{ play_fact_device_1_boot_partlabel }}"
        disk_format_def_device_1_zfs_partlabel: "{{ play_fact_device_1_zfs_partlabel }}"
        disk_format_def_device_2_boot_partlabel: "{{ play_fact_device_2_boot_partlabel }}"
        disk_format_def_device_2_zfs_partlabel: "{{ play_fact_device_2_zfs_partlabel }}"
    - include_role:
        name: pool-creation
      vars:
        pool_creation_def_device_1_zfs_partlabel: "{{ play_fact_device_1_zfs_partlabel }}"
        pool_creation_def_device_2_zfs_partlabel: "{{ play_fact_device_2_zfs_partlabel }}"

